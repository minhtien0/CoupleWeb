<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Couple App - ƒêƒÉng nh·∫≠p</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif']
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                        'hearts': 'hearts 2s ease-in-out infinite',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                        'slideInUp': 'slideInUp 0.5s ease-out',
                        'fadeIn': 'fadeIn 0.3s ease-out',
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @keyframes float {
            0%,
            100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-10px);
            }
        }
        
        @keyframes hearts {
            0%,
            100% {
                transform: scale(1);
                opacity: 0.7;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
        }
        
        @keyframes glow {
            0% {
                box-shadow: 0 0 20px rgba(236, 72, 153, 0.3);
            }
            100% {
                box-shadow: 0 0 30px rgba(236, 72, 153, 0.6);
            }
        }
        
        @keyframes slideInUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        .auth-card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .couple-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
        }
        
        .couple-bg::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: float 20s infinite linear;
        }
        
        .floating-heart {
            position: absolute;
            animation: hearts 3s ease-in-out infinite;
        }
        
        .floating-heart:nth-child(1) {
            top: 10%;
            left: 10%;
            animation-delay: 0s;
        }
        
        .floating-heart:nth-child(2) {
            top: 20%;
            right: 15%;
            animation-delay: 0.5s;
        }
        
        .floating-heart:nth-child(3) {
            bottom: 20%;
            left: 20%;
            animation-delay: 1s;
        }
        
        .floating-heart:nth-child(4) {
            bottom: 15%;
            right: 10%;
            animation-delay: 1.5s;
        }
        
        .input-group {
            transition: all 0.3s ease;
        }
        
        .input-group:focus-within {
            transform: translateY(-2px);
        }
        
        .code-input {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .code-input:focus {
            background: white;
            border-color: #ec4899;
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
        }
        
        .step-indicator {
            transition: all 0.5s ease;
        }
        
        .step-indicator.active {
            background: linear-gradient(135deg, #ec4899, #8b5cf6);
            color: white;
            transform: scale(1.1);
        }
        
        .loading-dots::after {
            content: '';
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% {
                content: '';
            }
            33% {
                content: '.';
            }
            66% {
                content: '..';
            }
            100% {
                content: '...';
            }
        }
    </style>
</head>

<body class="min-h-screen couple-bg font-sans">

    <!-- Floating Hearts Background -->
    <div class="floating-heart text-pink-300 text-2xl opacity-60">üíï</div>
    <div class="floating-heart text-rose-300 text-xl opacity-50">üíñ</div>
    <div class="floating-heart text-purple-300 text-lg opacity-70">üíù</div>
    <div class="floating-heart text-pink-400 text-xl opacity-60">üíó</div>

    <!-- Main Container -->
    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md">

            <!-- App Logo & Title -->
            <div class="text-center mb-8 animate-slideInUp">
                <div class="w-20 h-20 bg-gradient-to-r from-pink-500 to-purple-500 rounded-3xl flex items-center justify-center mx-auto mb-4 animate-glow">
                    <svg class="w-10 h-10 text-white animate-hearts" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                    </svg>
                </div>
                <h1 class="text-3xl font-bold text-white mb-2">Couple App</h1>
                <p class="text-white/80 text-sm">·ª®ng d·ª•ng qu·∫£n l√Ω t√¨nh y√™u cho c√°c c·∫∑p ƒë√¥i</p>
            </div>

            <!-- Auth Card -->
            <div class="auth-card rounded-3xl shadow-2xl border border-white/20 p-8 animate-slideInUp">

                <!-- Step Indicator -->
                <div class="flex justify-center space-x-4 mb-8" id="step-indicators">
                    <div class="step-indicator active w-8 h-8 rounded-full flex items-center justify-center text-sm font-semibold bg-gray-200 text-gray-600">1</div>
                    <div class="w-12 h-0.5 bg-gray-200 self-center"></div>
                    <div class="step-indicator w-8 h-8 rounded-full flex items-center justify-center text-sm font-semibold bg-gray-200 text-gray-600">2</div>
                    <div class="w-12 h-0.5 bg-gray-200 self-center"></div>
                    <div class="step-indicator w-8 h-8 rounded-full flex items-center justify-center text-sm font-semibold bg-gray-200 text-gray-600">3</div>
                </div>

                <!-- Step 1: Welcome & Choice -->
                <div id="step-1" class="space-y-6">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-2">Ch√†o m·ª´ng! üëã</h2>
                        <p class="text-gray-600">B·∫°n mu·ªën b·∫Øt ƒë·∫ßu nh∆∞ th·∫ø n√†o?</p>
                    </div>

                    <div class="space-y-4">
                        <button onclick="selectChoice('create')" class="w-full p-6 bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white rounded-2xl font-medium transition-all hover:scale-105 hover:shadow-xl">
                            <div class="flex items-center justify-center space-x-3">
                                <span class="text-2xl">üíï</span>
                                <div class="text-left">
                                    <div class="font-semibold">T·∫°o t√†i kho·∫£n m·ªõi</div>
                                    <div class="text-sm text-pink-100">T√¥i mu·ªën t·∫°o t√†i kho·∫£n couple ƒë·∫ßu ti√™n</div>
                                </div>
                            </div>
                        </button>

                        <button onclick="showLoginForm()" class="w-full p-6 bg-gradient-to-r from-purple-500 to-indigo-500 hover:from-purple-600 hover:to-indigo-600 text-white rounded-2xl font-medium transition-all hover:scale-105 hover:shadow-xl">
                            <div class="flex items-center justify-center space-x-3">
                                <span class="text-2xl">üîó</span>
                                <div class="text-left">
                                    <div class="font-semibold">ƒêƒÉng nh·∫≠p t√†i kho·∫£n</div>
                                    <div class="text-sm text-purple-100">T√¨m ki·∫øm ng∆∞·ªùi y√™u c√πng t√¥i nh√©</div>
                                </div>
                            </div>
                        </button>
                    </div>

                    <div class="text-center">
                        <button onclick="" class="text-gray-600 hover:text-gray-800 text-sm transition-colors">
                            ƒê√£ c√≥ t√†i kho·∫£n? <span class="font-medium underline">Qu√™n m·∫≠t kh·∫©u</span>
                        </button>
                    </div>
                </div>

                <!-- Step 2: Personal Info -->
                <div id="step-2" class="space-y-6 hidden">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-2" id="step-2-title">T·∫°o h·ªì s∆° c√° nh√¢n</h2>
                        <p class="text-gray-600" id="step-2-subtitle">ƒêi·ªÅn th√¥ng tin ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
                    </div>

                    <form id="personal-form" action="/register" method="POST" class="space-y-4">
                        <div class="input-group">
                            <label class="block text-sm font-medium text-gray-700 mb-2">T√™n hi·ªÉn th·ªã</label>
                            <input type="text" name="displayName" id="display-name" class="w-full p-4 border border-gray-200 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-all" placeholder="VD: An, Minh...">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="input-group">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sinh nh·∫≠t</label>
                                <input type="date" name="birthday" id="birthday" class="w-full p-4 border border-gray-200 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-all">
                            </div>
                            <div class="input-group">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Gi·ªõi t√≠nh</label>
                                <select name="gender" id="gender" class="w-full p-4 border border-gray-200 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-all">
                    <option value="">Ch·ªçn gi·ªõi t√≠nh</option>
                    <option value="N·ªØ">N·ªØ üë©</option>
                    <option value="Nam">Nam üë®</option>
                    <option value="Kh√°c">Kh√°c üë§</option>
                </select>
                            </div>
                        </div>

                        <div class="input-group">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" name="email" id="email" class="w-full p-4 border border-gray-200 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-all" placeholder="your@email.com">
                        </div>

                        <div class="input-group">
                            <label class="block text-sm font-medium text-gray-700 mb-2">M·∫≠t kh·∫©u</label>
                            <input type="password" name="password" id="password" class="w-full p-4 border border-gray-200 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-all" placeholder="T·ªëi thi·ªÉu 6 k√Ω t·ª±">
                        </div>
                        <div>
                            <p id="form-error" class="text-red-500 text-sm"></p>
                        </div>

                        <div id="couple-code-section" class="input-group hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">M√£ couple</label>
                            <input type="text" id="couple-code" class="code-input w-full p-4 rounded-xl text-center text-lg font-mono font-bold tracking-wider uppercase focus:outline-none" placeholder="LOVE2024" maxlength="8">
                            <p class="text-sm text-gray-500 mt-2 text-center">Nh·∫≠p m√£ 8 k√Ω t·ª± m√† ng∆∞·ªùi y√™u ƒë√£ chia s·∫ª</p>
                        </div>
                    </form>

                    <div class="flex space-x-3">
                        <button onclick="goToStep(1)" class="px-6 py-3 border border-gray-300 rounded-xl text-gray-700 font-medium hover:bg-gray-50 transition-colors">
            ‚Üê Quay l·∫°i
        </button>
                        <button type="submit" form="personal-form" class="flex-1 py-3 px-6 bg-gradient-to-r from-pink-500 to-purple-500 text-white rounded-xl font-medium hover:shadow-lg transition-all">
            Ti·∫øp t·ª•c ‚Üí
        </button>
                    </div>
                </div>

                <script>
                    document.getElementById("personal-form").addEventListener("submit", async function(e) {
                        e.preventDefault(); // NgƒÉn reload trang

                        const form = e.target;
                        const formData = new FormData(form);

                        // Convert FormData -> JSON
                        const data = Object.fromEntries(formData.entries());

                        try {
                            const res = await fetch("/register", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json"
                                },
                                body: JSON.stringify(data)
                            });

                            const result = await res.json();

                            if (result.success) {
                                // ‚úÖ ƒêƒÉng k√Ω th√†nh c√¥ng -> sang b∆∞·ªõc 3
                                goToStep(3);
                            } else {
                                // ‚ùå Hi·ªÉn th·ªã l·ªói
                                alert(result.message);
                            }
                        } catch (error) {
                            console.error(error);
                            alert("C√≥ l·ªói k·∫øt n·ªëi server!");
                        }
                    });
                </script>


                <!-- Step 3: Couple Connection -->
                <div id="step-3" class="space-y-6 hidden">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-2">K·∫øt n·ªëi ƒë√¥i</h2>
                        <p class="text-gray-600">T·∫°o ho·∫∑c nh·∫≠p m√£ ƒë·ªÉ gh√©p c·∫∑p</p>
                    </div>

                    <!-- Create Couple Code -->
                    <div id="create-code-section" class="space-y-4">
                        <div class="bg-gradient-to-br from-pink-50 to-purple-50 rounded-2xl p-6 border border-pink-200">
                            <div class="text-center">
                                <div class="text-2xl mb-4 animate-float">üíï</div>
                                <h3 class="font-semibold text-gray-800 mb-2">M√£ couple c·ªßa b·∫°n</h3>
                                <div class="bg-white rounded-xl p-4 mb-4">
                                    <div class="text-3xl font-mono font-bold text-pink-600 tracking-wider" id="generated-code">LOVE2025</div>
                                </div>
                                <p class="text-sm text-gray-600 mb-4">Chia s·∫ª m√£ n√†y v·ªõi ng∆∞·ªùi y√™u ƒë·ªÉ k·∫øt n·ªëi</p>
                                <div class="flex space-x-2">
                                    <button onclick="copyCode()" class="flex-1 py-2 px-4 bg-white border border-pink-200 rounded-lg text-pink-600 font-medium hover:bg-pink-50 transition-colors">
                                        üìã Copy m√£
                                    </button>
                                    <button onclick="shareCode()" class="flex-1 py-2 px-4 bg-pink-500 text-white rounded-lg font-medium hover:bg-pink-600 transition-colors">
                                        üì§ Chia s·∫ª
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="text-center">
                            <p class="text-sm text-gray-500 mb-4">Ch·ªù ng∆∞·ªùi y√™u k·∫øt n·ªëi...</p>
                            <div class="loading-dots text-pink-500 font-semibold">ƒêang ch·ªù</div>
                        </div>
                    </div>

                    <!-- Join with Code -->
                    <div id="join-code-section" class="space-y-4 hidden">
                        <div class="bg-gradient-to-br from-purple-50 to-indigo-50 rounded-2xl p-6 border border-purple-200">
                            <div class="text-center">
                                <div class="text-2xl mb-4 animate-float">üîó</div>
                                <h3 class="font-semibold text-gray-800 mb-4">Nh·∫≠p m√£ couple</h3>
                                <input type="text" id="join-couple-code" class="code-input w-full p-4 rounded-xl text-center text-2xl font-mono font-bold tracking-wider uppercase focus:outline-none mb-4" placeholder="LOVE2024" maxlength="8">
                                <button onclick="joinCouple()" class="w-full py-3 px-6 bg-gradient-to-r from-purple-500 to-indigo-500 text-white rounded-xl font-medium hover:shadow-lg transition-all">
                                    üîó K·∫øt n·ªëi ngay
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Connection Status -->
                    <div id="connection-status" class="hidden">
                        <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl p-6 border border-green-200 text-center">
                            <div class="text-3xl mb-4 animate-hearts">üíö</div>
                            <h3 class="font-semibold text-gray-800 mb-2">K·∫øt n·ªëi th√†nh c√¥ng!</h3>
                            <p class="text-sm text-gray-600 mb-4">Ch√∫c m·ª´ng! B·∫°n ƒë√£ ƒë∆∞·ª£c gh√©p c·∫∑p th√†nh c√¥ng</p>
                            <button onclick="completeRegistration()" class="py-3 px-6 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-xl font-medium hover:shadow-lg transition-all">
                                B·∫Øt ƒë·∫ßu h√†nh tr√¨nh y√™u üíï
                            </button>
                        </div>
                    </div>

                    <div class="flex space-x-3">
                        <button onclick="goToStep(2)" class="px-6 py-3 border border-gray-300 rounded-xl text-gray-700 font-medium hover:bg-gray-50 transition-colors">
                            ‚Üê Quay l·∫°i
                        </button>
                        <button onclick="skipConnection()" class="flex-1 py-3 px-6 border border-gray-300 rounded-xl text-gray-700 font-medium hover:bg-gray-50 transition-colors">
                            B·ªè qua (k·∫øt n·ªëi sau)
                        </button>
                    </div>
                </div>

                <!-- Login Form -->
                <div id="login-form" class="space-y-6 hidden">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-2">ƒêƒÉng nh·∫≠p</h2>
                        <p class="text-gray-600">Ch√†o m·ª´ng tr·ªü l·∫°i!</p>
                    </div>

                    <div class="space-y-4">
                        <div class="input-group">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="login-email" class="w-full p-4 border border-gray-200 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-all" placeholder="your@email.com">
                        </div>

                        <div class="input-group">
                            <label class="block text-sm font-medium text-gray-700 mb-2">M·∫≠t kh·∫©u</label>
                            <input type="password" id="login-password" class="w-full p-4 border border-gray-200 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-all" placeholder="M·∫≠t kh·∫©u c·ªßa b·∫°n">
                        </div>
                        <div>
                            <div>
                                <p id="login-error" class="text-red-500 text-sm"></p>
                                <!-- Th√™m ph·∫ßn n√†y -->
                            </div>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <label class="flex items-center">
                                <input type="checkbox" class="rounded border-gray-300 text-pink-500 focus:ring-pink-500">
                                <span class="ml-2 text-gray-600">Ghi nh·ªõ ƒëƒÉng nh·∫≠p</span>
                            </label>
                            <button onclick="forgotPassword()" class="text-pink-600 hover:text-pink-700 font-medium">
                                Qu√™n m·∫≠t kh·∫©u?
                            </button>
                        </div>
                    </div>

                    <button type="submit" onclick="login(event)" class="w-full py-4 bg-gradient-to-r from-pink-500 to-purple-500 text-white rounded-xl font-medium text-lg hover:shadow-lg transition-all">
                        ƒêƒÉng nh·∫≠p
                    </button>

                    <div class="text-center">
                        <button onclick="showRegister()" class="text-gray-600 hover:text-gray-800 text-sm transition-colors">
                            Ch∆∞a c√≥ t√†i kho·∫£n? <span class="font-medium underline">ƒêƒÉng k√Ω ngay</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Terms & Privacy -->
            <div class="text-center mt-6 text-white/70 text-xs space-y-1 animate-fadeIn">
                <p>B·∫±ng vi·ªác ti·∫øp t·ª•c, b·∫°n ƒë·ªìng √Ω v·ªõi</p>
                <div class="space-x-4">
                    <button onclick="showTerms()" class="underline hover:text-white transition-colors">ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng</button>
                    <button onclick="showPrivacy()" class="underline hover:text-white transition-colors">Ch√≠nh s√°ch b·∫£o m·∫≠t</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Animation Overlay -->
    <div id="success-overlay" class="fixed inset-0 bg-gradient-to-br from-pink-500/90 to-purple-500/90 backdrop-blur-sm z-50 flex items-center justify-center hidden">
        <div class="text-center text-white animate-slideInUp">
            <div class="text-8xl mb-6 animate-hearts">üíï</div>
            <h2 class="text-4xl font-bold mb-4">Ch√∫c m·ª´ng!</h2>
            <p class="text-xl mb-8">B·∫°n ƒë√£ tham gia Couple App th√†nh c√¥ng</p>
            <div class="loading-dots text-2xl">ƒêang chuy·ªÉn h∆∞·ªõng</div>
        </div>
    </div>

    <script>
        // State management
        let currentStep = 1;
        let selectedChoice = null;
        let generatedCode = 'LOVE2025';

        const userData = {
            displayName: '',
            birthday: '',
            gender: '',
            email: '',
            password: '',
            coupleCode: ''
        };

        // Step navigation
        function goToStep(step) {
            // Hide all steps
            document.querySelectorAll('[id^="step-"]').forEach(el => {
                el.classList.add('hidden');
            });

            // Show target step
            document.getElementById(`step-${step}`).classList.remove('hidden');

            // Update step indicators
            updateStepIndicators(step);
            currentStep = step;
        }

        function updateStepIndicators(activeStep) {
            const indicators = document.querySelectorAll('.step-indicator');
            indicators.forEach((indicator, index) => {
                const stepNumber = index + 1;
                if (stepNumber <= activeStep) {
                    indicator.classList.add('active');
                } else {
                    indicator.classList.remove('active');
                }
            });
        }

        // Choice selection
        function selectChoice(choice) {
            selectedChoice = choice;

            if (choice === 'create') {
                document.getElementById('step-2-title').textContent = 'T·∫°o h·ªì s∆° c√° nh√¢n';
                document.getElementById('step-2-subtitle').textContent = 'ƒêi·ªÅn th√¥ng tin ƒë·ªÉ t·∫°o t√†i kho·∫£n couple';
                document.getElementById('couple-code-section').classList.add('hidden');
                document.getElementById('create-code-section').classList.remove('hidden');
                document.getElementById('join-code-section').classList.add('hidden');
            } else if (choice === 'join') {
                document.getElementById('step-2-title').textContent = 'Tham gia b·∫±ng m√£ couple';
                document.getElementById('step-2-subtitle').textContent = 'Nh·∫≠p th√¥ng tin ƒë·ªÉ tham gia couple';
                document.getElementById('couple-code-section').classList.remove('hidden');
                document.getElementById('create-code-section').classList.add('hidden');
                document.getElementById('join-code-section').classList.remove('hidden');
            }

            goToStep(2);
        }

        // Form validation
        function validateStep2() {
            const requiredFields = ['display-name', 'birthday', 'gender', 'email', 'password'];
            let isValid = true;

            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.classList.add('border-red-500');
                    isValid = false;
                } else {
                    field.classList.remove('border-red-500');
                }
            });

            if (selectedChoice === 'join') {
                const coupleCodeField = document.getElementById('couple-code');
                if (!coupleCodeField.value.trim()) {
                    coupleCodeField.classList.add('border-red-500');
                    isValid = false;
                } else {
                    coupleCodeField.classList.remove('border-red-500');
                }
            }

            if (!isValid) {
                alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!');
                return false;
            }

            // Validate email
            const email = document.getElementById('email').value;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                document.getElementById('email').classList.add('border-red-500');
                alert('Email kh√¥ng h·ª£p l·ªá!');
                return false;
            }

            // Validate password
            const password = document.getElementById('password').value;
            if (password.length < 6) {
                document.getElementById('password').classList.add('border-red-500');
                alert('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!');
                return false;
            }

            return true;
        }

        // Code generation and management
        function generateCoupleCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 8; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            generatedCode = result;
            document.getElementById('generated-code').textContent = result;
        }

        function copyCode() {
            navigator.clipboard.writeText(generatedCode).then(() => {
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '‚úÖ ƒê√£ copy!';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            });
        }

        function shareCode() {
            if (navigator.share) {
                navigator.share({
                    title: 'Couple App - M√£ k·∫øt n·ªëi',
                    text: `H√£y t·∫£i Couple App v√† s·ª≠ d·ª•ng m√£: ${generatedCode} ƒë·ªÉ k·∫øt n·ªëi v·ªõi t√¥i! üíï`,
                    url: window.location.origin
                });
            } else {
                copyCode();
                alert('M√£ ƒë√£ ƒë∆∞·ª£c copy! H√£y chia s·∫ª cho ng∆∞·ªùi y√™u c·ªßa b·∫°n üíï');
            }
        }

        function joinCouple() {
            const code = document.getElementById('join-couple-code').value.trim().toUpperCase();

            if (!code) {
                alert('Vui l√≤ng nh·∫≠p m√£ couple!');
                return;
            }

            if (code.length !== 8) {
                alert('M√£ couple ph·∫£i c√≥ 8 k√Ω t·ª±!');
                return;
            }

            // Simulate API call to join couple
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'üîÑ ƒêang k·∫øt n·ªëi...';
            button.disabled = true;

            setTimeout(() => {
                // Simulate successful connection
                document.getElementById('join-code-section').classList.add('hidden');
                document.getElementById('connection-status').classList.remove('hidden');
                button.textContent = originalText;
                button.disabled = false;
            }, 60000);
        }

        // Auth functions
        function showLoginForm() {
            // Hide step indicators and all steps
            document.getElementById('step-indicators').classList.add('hidden');
            document.querySelectorAll('[id^="step-"]').forEach(el => {
                el.classList.add('hidden');
            });

            // Show login form
            document.getElementById('login-form').classList.remove('hidden');
        }

        function showRegister() {
            // Show step indicators and go to step 1
            document.getElementById('step-indicators').classList.remove('hidden');
            document.getElementById('login-form').classList.add('hidden');
            goToStep(1);
        }

        function login(event) {
            // Kh√¥ng c·∫ßn preventDefault n·∫øu kh√¥ng trong form, nh∆∞ng gi·ªØ ƒë·ªÉ an to√†n
            if (event) event.preventDefault();

            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value.trim();
            const errorElement = document.getElementById('login-error');
            const button = event ? event.target : document.querySelector('button[onclick="login()"]'); // Fallback n·∫øu kh√¥ng c√≥ event
            const originalText = button.textContent;

            // Reset l·ªói tr∆∞·ªõc ƒë√≥
            if (errorElement) errorElement.textContent = '';

            // 1. Ki·ªÉm tra kh√¥ng b·ªè tr·ªëng (KH√îNG thay ƒë·ªïi n√∫t ·ªü ƒë√¢y)
            if (!email || !password) {
                if (errorElement) errorElement.textContent = 'Vui l√≤ng nh·∫≠p email v√† m·∫≠t kh·∫©u!';
                console.log('Validation fail: Missing fields'); // Debug
                return; // D·ª´ng, kh√¥ng loading, kh√¥ng g·ª≠i request
            }

            console.log('Validation pass: Starting loading and request'); // Debug

            // 2. Hi·ªáu ·ª©ng loading CH·ªà khi validation pass (g·ª≠i request h·ª£p l·ªá)
            button.textContent = 'üîÑ ƒêang ƒëƒÉng nh·∫≠p...';
            button.disabled = true;

            // 3. G·ª≠i AJAX request
            fetch('/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email,
                        password
                    })
                })
                .then(res => res.json())
                .then(data => {
                    console.log('Server response:', data); // Debug
                    if (data.success) {
                        // ‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng
                        showSuccessOverlay();
                        setTimeout(() => {
                            window.location.href = data.redirect; // T·ª± ƒë·ªông chuy·ªÉn /matching ho·∫∑c /home
                        }, 3000);
                    } else {
                        // ‚ùå Sai email ho·∫∑c m·∫≠t kh·∫©u (KH√îI PH·ª§C N√öT)
                        if (errorElement) errorElement.textContent = data.message || 'Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!';
                        // Kh√¥ng d√πng alert ƒë·ªÉ tr√°nh popup; ch·ªâ hi·ªÉn th·ªã message
                        console.log('Login fail:', data.message);
                        button.textContent = originalText;
                        button.disabled = false;
                    }
                })
                .catch(err => {
                    console.error('L·ªói:', err);
                    if (errorElement) errorElement.textContent = 'Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi server!';
                    // KH√îI PH·ª§C N√öT
                    button.textContent = originalText;
                    button.disabled = false;
                });
        }


        function forgotPassword() {
            const email = prompt('Nh·∫≠p email ƒë·ªÉ ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u:');
            if (email) {
                alert(`ƒê√£ g·ª≠i link ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u t·ªõi ${email}!\nVui l√≤ng ki·ªÉm tra email c·ªßa b·∫°n.`);
            }
        }

        // Registration flow
        function completeRegistration() {
            // Collect user data
            userData.displayName = document.getElementById('display-name').value;
            userData.birthday = document.getElementById('birthday').value;
            userData.gender = document.getElementById('gender').value;
            userData.email = document.getElementById('email').value;
            userData.password = document.getElementById('password').value;

            if (selectedChoice === 'join') {
                userData.coupleCode = document.getElementById('couple-code').value;
            }

            // Simulate registration API call
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'üîÑ ƒêang t·∫°o t√†i kho·∫£n...';
            button.disabled = true;

            setTimeout(() => {
                showSuccessOverlay();
                setTimeout(() => {
                    window.location.href = '/matching'; // Redirect to matching page 
                }, 3000);
            }, 2000);
        }

        function skipConnection() {
            // Allow user to skip couple connection and use app solo
            if (confirm('B·∫°n c√≥ th·ªÉ k·∫øt n·ªëi v·ªõi ng∆∞·ªùi y√™u sau n√†y. Ti·∫øp t·ª•c t·∫°o t√†i kho·∫£n c√° nh√¢n?')) {
                completeRegistration();
            }
        }

        // UI effects
        function showSuccessOverlay() {
            document.getElementById('success-overlay').classList.remove('hidden');
        }

        function showTerms() {
            alert('ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng:\n\n‚Ä¢ ·ª®ng d·ª•ng d√†nh cho ng∆∞·ªùi tr√™n 18 tu·ªïi\n‚Ä¢ Kh√¥ng chia s·∫ª th√¥ng tin c√° nh√¢n v·ªõi b√™n th·ª© 3\n‚Ä¢ T√¥n tr·ªçng quy·ªÅn ri√™ng t∆∞ c·ªßa ƒë·ªëi ph∆∞∆°ng\n‚Ä¢ S·ª≠ d·ª•ng ·ª©ng d·ª•ng m·ªôt c√°ch t√≠ch c·ª±c');
        }

        function showPrivacy() {
            alert('Ch√≠nh s√°ch b·∫£o m·∫≠t:\n\n‚Ä¢ D·ªØ li·ªáu ƒë∆∞·ª£c m√£ h√≥a end-to-end\n‚Ä¢ Kh√¥ng thu th·∫≠p th√¥ng tin kh√¥ng c·∫ßn thi·∫øt\n‚Ä¢ Ng∆∞·ªùi d√πng c√≥ quy·ªÅn x√≥a d·ªØ li·ªáu\n‚Ä¢ Tu√¢n th·ªß GDPR v√† c√°c quy ƒë·ªãnh v·ªÅ b·∫£o m·∫≠t');
        }

        // Auto-formatting for couple code inputs
        function setupCodeInputs() {
            const codeInputs = document.querySelectorAll('#couple-code, #join-couple-code');
            codeInputs.forEach(input => {
                input.addEventListener('input', function() {
                    this.value = this.value.replace(/[^A-Z0-9]/g, '').substring(0, 8);
                });

                input.addEventListener('keyup', function() {
                    this.value = this.value.toUpperCase();
                });
            });
        }

        // Enhanced step 2 navigation with validation
        document.addEventListener('DOMContentLoaded', function() {
            // Override the step 3 navigation button
            const step2ContinueBtn = document.querySelector('#step-2 button[onclick="goToStep(3)"]');
            if (step2ContinueBtn) {
                step2ContinueBtn.onclick = function() {
                    if (validateStep2()) {
                        goToStep(3);

                        // Generate new couple code if creating
                        if (selectedChoice === 'create') {
                            generateCoupleCode();
                            // Simulate waiting for partner
                            simulatePartnerConnection();
                        }
                    }
                };
            }

            // Setup code input formatting
            setupCodeInputs();

            // Add real-time validation
            const inputs = document.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('blur', function() {
                    if (this.value.trim()) {
                        this.classList.remove('border-red-500');
                        this.classList.add('border-green-500');
                    }
                });

                input.addEventListener('focus', function() {
                    this.classList.remove('border-red-500', 'border-green-500');
                });
            });
        });

        // Simulate partner connection process
        function simulatePartnerConnection() {
            if (selectedChoice === 'create') {
                // Simulate random connection after 5-15 seconds
                const connectionTime = Math.random() * 10000 + 5000;
                setTimeout(() => {
                    if (Math.random() > 0.3) { // 70% success rate
                        // Success case
                        document.getElementById('create-code-section').classList.add('hidden');
                        document.getElementById('connection-status').classList.remove('hidden');
                    } else {
                        // Still waiting case
                        const loadingText = document.querySelector('.loading-dots');
                        loadingText.textContent = 'V·∫´n ƒëang ch·ªù k·∫øt n·ªëi...';

                        // Add helpful message
                        const helpDiv = document.createElement('div');
                        helpDiv.className = 'text-center mt-4';
                        helpDiv.innerHTML = `
                            <p class="text-sm text-gray-600 mb-2">M·∫•t nhi·ªÅu th·ªùi gian h∆°n d·ª± ki·∫øn?</p>
                            <button onclick="resendCode()" class="text-pink-600 text-sm font-medium hover:underline">
                                üì§ G·ª≠i l·∫°i m√£
                            </button>
                        `;
                        document.getElementById('create-code-section').appendChild(helpDiv);
                    }
                }, connectionTime);
            }
        }

        function resendCode() {
            alert('M√£ couple ƒë√£ ƒë∆∞·ª£c g·ª≠i l·∫°i qua:\n\nüìß Email\nüì± SMS\nüí¨ C√°c ·ª©ng d·ª•ng nh·∫Øn tin\n\nH√£y ki·ªÉm tra v√† chia s·∫ª v·ªõi ng∆∞·ªùi y√™u!');
        }

        // Enhanced error handling
        function handleError(error, context) {
            console.error(`Error in ${context}:`, error);

            let userMessage = 'C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i sau.';

            switch (context) {
                case 'registration':
                    userMessage = 'Kh√¥ng th·ªÉ t·∫°o t√†i kho·∫£n. Vui l√≤ng ki·ªÉm tra th√¥ng tin v√† th·ª≠ l·∫°i.';
                    break;
                case 'login':
                    userMessage = 'Th√¥ng tin ƒëƒÉng nh·∫≠p kh√¥ng ch√≠nh x√°c.';
                    break;
                case 'couple_connection':
                    userMessage = 'Kh√¥ng th·ªÉ k·∫øt n·ªëi couple. Ki·ªÉm tra m√£ v√† th·ª≠ l·∫°i.';
                    break;
            }

            alert(userMessage);
        }

        // Social login simulation (future feature)
        function socialLogin(provider) {
            alert(`T√≠nh nƒÉng ƒëƒÉng nh·∫≠p b·∫±ng ${provider} s·∫Ω c√≥ trong phi√™n b·∫£n ti·∫øp theo! üöÄ`);
        }

        // Demo data for testing
        function fillDemoData() {
            document.getElementById('display-name').value = 'An';
            document.getElementById('birthday').value = '2001-03-15';
            document.getElementById('gender').value = 'female';
            document.getElementById('email').value = 'an@example.com';
            document.getElementById('password').value = 'password123';

            if (selectedChoice === 'join') {
                document.getElementById('couple-code').value = 'DEMO2024';
            }
        }

        // Easter egg - konami code for demo data
        let konamiCode = [];
        const konamiSequence = [38, 38, 40, 40, 37, 39, 37, 39, 66, 65]; // ‚Üë‚Üë‚Üì‚Üì‚Üê‚Üí‚Üê‚ÜíBA

        document.addEventListener('keydown', function(e) {
            konamiCode.push(e.keyCode);
            if (konamiCode.length > konamiSequence.length) {
                konamiCode.shift();
            }

            if (JSON.stringify(konamiCode) === JSON.stringify(konamiSequence)) {
                fillDemoData();
                alert('üéÆ Demo data loaded! Konami code activated!');
                konamiCode = [];
            }
        });

        // Accessibility enhancements
        document.addEventListener('DOMContentLoaded', function() {
            // Add ARIA labels
            const inputs = document.querySelectorAll('input, select');
            inputs.forEach(input => {
                const label = input.previousElementSibling;
                if (label && label.tagName === 'LABEL') {
                    input.setAttribute('aria-describedby', input.id + '-help');
                }
            });

            // Add keyboard navigation for steps
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && e.target.tagName === 'BUTTON') {
                    e.target.click();
                }
            });
        });

        // Performance optimization
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Add debounced validation for real-time feedback
        const debouncedValidation = debounce(function(input) {
            if (input.value.trim()) {
                // Show success state
                input.classList.remove('border-red-500');
                input.classList.add('border-green-300');
            }
        }, 500);

        // Apply to all inputs
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('input', () => debouncedValidation(input));
            });
        });

        // Analytics simulation (for future implementation)
        function trackEvent(eventName, properties = {}) {
            console.log(`Analytics Event: ${eventName}`, properties);
            // In real app, this would send to analytics service
        }

        // Track user journey
        function trackStep(stepNumber) {
            trackEvent('auth_step_completed', {
                step: stepNumber,
                choice: selectedChoice,
                timestamp: new Date().toISOString()
            });
        }

        // Override goToStep to include tracking
        const originalGoToStep = goToStep;
        goToStep = function(step) {
            originalGoToStep(step);
            trackStep(step);
        };
    </script>
</body>

</html>