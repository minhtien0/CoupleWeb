<script>
    // ==================== LOVE TEST ====================
    const loveQuestions = [{
        topic: "quality_time",
        q: "B·∫°n th√≠ch nh·∫•t khi c·∫£ hai c√πng d√†nh th·ªùi gian ri√™ng cho nhau?"
    }, {
        topic: "quality_time",
        q: "B·∫°n c·∫£m th·∫•y h·∫°nh ph√∫c khi ƒë∆∞·ª£c tr√≤ chuy·ªán v√† k·∫øt n·ªëi?"
    }, {
        topic: "quality_time",
        q: "B·∫°n th√≠ch nh·ªØng bu·ªïi h·∫πn ch·ªâ c√≥ hai ng∆∞·ªùi?"
    }, {
        topic: "acts_of_service",
        q: "B·∫°n c·∫£m ƒë·ªông khi n·ª≠a kia gi√∫p b·∫°n l√†m vi·ªác nh√†?"
    }, {
        topic: "acts_of_service",
        q: "B·∫°n th√≠ch ƒë∆∞·ª£c h·ªó tr·ª£ khi m·ªát m·ªèi?"
    }, {
        topic: "acts_of_service",
        q: "B·∫°n r·∫•t tr√¢n tr·ªçng nh·ªØng h√†nh ƒë·ªông quan t√¢m nh·ªè?"
    }, {
        topic: "words_of_affirmation",
        q: "B·∫°n th√≠ch nghe l·ªùi khen t·ª´ ƒë·ªëi ph∆∞∆°ng?"
    }, {
        topic: "words_of_affirmation",
        q: "B·∫°n th·∫•y vui khi ƒë∆∞·ª£c ƒë·ªông vi√™n tinh th·∫ßn?"
    }, {
        topic: "words_of_affirmation",
        q: "B·∫°n th√≠ch nh·ªØng tin nh·∫Øn y√™u th∆∞∆°ng?"
    }, {
        topic: "physical_touch",
        q: "B·∫°n th√≠ch nh·ªØng c√°i √¥m b·∫•t ng·ªù?"
    }, {
        topic: "physical_touch",
        q: "B·∫°n c·∫£m th·∫•y an to√†n khi ƒë∆∞·ª£c n·∫Øm tay?"
    }, {
        topic: "physical_touch",
        q: "B·∫°n th√≠ch s·ª± g·∫ßn g≈©i v·ªÅ m·∫∑t th·ªÉ x√°c?"
    }];

    let loveTestIndex = 0;
    let loveTestAnswers = [];

    function getLoveTestData() {
        let result = {
            quality_time: 0,
            acts_of_service: 0,
            words_of_affirmation: 0,
            physical_touch: 0
        };

        loveQuestions.forEach((q, i) => {
            result[q.topic] += loveTestAnswers[i] || 0;
        });

        return result;
    }

    function openLoveTest() {
        document.getElementById("loveTestOverlay").classList.remove("hidden");
        loadLoveQuestion();
    }

    function closeLoveTest() {
        document.getElementById("loveTestOverlay").classList.add("hidden");
    }

    function loadLoveQuestion() {
        const q = loveQuestions[loveTestIndex];
        document.getElementById("loveTestQuestion").innerText = (loveTestIndex + 1) + ". " + q.q;

        document.getElementById("loveTestOptions").innerHTML = `
            <label class="flex items-center space-x-3">
                <input type="radio" name="answer" value="1" class="w-4 h-4">
                <span>Ho√†n to√†n ƒë√∫ng</span>
            </label>
            <label class="flex items-center space-x-3">
                <input type="radio" name="answer" value="0" class="w-4 h-4">
                <span>Kh√¥ng h·∫≥n</span>
            </label>
        `;

        if (loveTestAnswers[loveTestIndex] !== undefined) {
            document.querySelector(`input[value="${loveTestAnswers[loveTestIndex]}"]`).checked = true;
        }

        document.getElementById("testProgress").style.width = ((loveTestIndex + 1) / 12) * 100 + "%";
        document.getElementById("submitLoveTestBtn").classList.toggle("hidden", loveTestIndex !== 11);
    }

    function nextQuestion() {
        const selected = document.querySelector("input[name='answer']:checked");
        if (!selected) return alert("H√£y ch·ªçn m·ªôt ƒë√°p √°n!");

        loveTestAnswers[loveTestIndex] = Number(selected.value);

        if (loveTestIndex < loveQuestions.length - 1) {
            loveTestIndex++;
            loadLoveQuestion();
        }
    }

    function prevQuestion() {
        if (loveTestIndex > 0) {
            loveTestIndex--;
            loadLoveQuestion();
        }
    }

    async function submitLoveTest() {
        const result = getLoveTestData();

        const res = await fetch("/journey/love-language/save", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(result)
        });

        const data = await res.json();
        alert("ƒê√£ l∆∞u k·∫øt qu·∫£ th√†nh c√¥ng!");
        closeLoveTest();
    }

    function updateLoveTest() {
        const data = getLoveTestData();

        fetch("/journey/love-language/update", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(data)
            })
            .then(res => res.json())
            .then(result => {
                alert(result.message);
                location.reload();
            });
    }

    // ==================== GOALS ====================
    function openGoalDetail(id) {
        fetch(`/journey/goals/${id}`)
            .then(res => res.json())
            .then(data => {
                    const g = data.goal;

                    document.getElementById("g-title").innerText = g.title;
                    document.getElementById("g-desc").innerText = g.description;
                    document.getElementById("g-date").innerText = `B·∫Øt ƒë·∫ßu: ${g.start_date}`;
                    document.getElementById("e-date").innerText = `K·∫øt th√∫c: ${g.end_date}`;

                    let percent = Math.round((g.current_value / g.target_value) * 100);

                    document.getElementById("g-progress-text").innerText =
                        `${g.current_value} / ${g.target_value} (${percent}%)`;
                    document.getElementById("g-progress-bar").style.width = percent + "%";

                    let html = "";
                    data.logs.forEach(log => {
                                html += `
                        <div class="border-b py-2">
                            <p class="text-sm">üìÖ ${log.time}</p>
                            ${log.image ? `<img src="/uploads/goals/${log.image}" class="w-20 rounded mt-1">` : ""}
                            <p class="text-xs text-gray-600">${log.note || ""}</p>
                        </div>`;
                });

                document.getElementById("g-logs").innerHTML = html || "Ch∆∞a c√≥ nh·∫≠t k√Ω n√†o";
                document.getElementById("checkin-goal-id").value = id;
                document.getElementById("goal-detail-modal").classList.remove("hidden");
            });
    }

    function closeGoalDetail() {
        document.getElementById("goal-detail-modal").classList.add("hidden");
    }

    document.addEventListener("DOMContentLoaded", function() {
        const checkinForm = document.getElementById("checkin-form");
        if (checkinForm) {
            checkinForm.onsubmit = async (e) => {
                e.preventDefault();
                let formData = new FormData(e.target);

                let res = await fetch("/journey/goals/checkin", {
                    method: "POST",
                    body: formData
                });

                let data = await res.json();

                if (data.success) {
                    alert("ƒêi·ªÉm danh th√†nh c√¥ng!");
                    closeGoalDetail();
                    location.reload();
                } else {
                    alert(data.message);
                }
            };
        }
    });

    function addNewGoal() {
        document.getElementById('goal-modal').classList.remove('hidden');
    }

    function closeGoalModal() {
        document.getElementById('goal-modal').classList.add('hidden');
        document.getElementById('goal-title').value = '';
        document.getElementById('goal-description').value = '';
    }

    async function createGoal() {
        const title = document.getElementById("goal-title").value.trim();
        const description = document.getElementById("goal-description").value.trim();
        const icon = document.getElementById("goal-icon").value;
        const target = document.getElementById("goal-target").value;
        const start = document.getElementById("goal-start").value;
        const end = document.getElementById("goal-end").value;

        if (!title || !target) {
            alert("Vui l√≤ng nh·∫≠p t√™n v√† gi√° tr·ªã m·ª•c ti√™u!");
            return;
        }

        try {
            const res = await fetch("/journey/goals/create", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    title,
                    description,
                    icon,
                    target_value: target,
                    start_date: start,
                    end_date: end
                })
            });

            const data = await res.json();

            if (!res.ok) {
                alert("‚ùå " + data.error);
                return;
            }

            alert("üéâ " + data.message);
            closeGoalModal();
            location.reload();

        } catch (error) {
            console.error(error);
            alert("L·ªói k·∫øt n·ªëi server!");
        }
    }

    // ==================== MILESTONES ====================
    function addMilestone() {
        document.getElementById("milestone-modal").classList.remove("hidden");
    }

    function closeMilestoneModal() {
        document.getElementById("milestone-modal").classList.add("hidden");
    }

    async function createMilestone() {
        const title = document.getElementById("ms-title").value.trim();
        const description = document.getElementById("ms-description").value.trim();
        const location = document.getElementById("ms-location").value.trim();
        const event_date = document.getElementById("ms-date").value;

        if (!title || !event_date) {
            return alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß ti√™u ƒë·ªÅ v√† ng√†y!");
        }

        const res = await fetch("/journey/milestone/create", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                title,
                description,
                location,
                event_date
            })
        });

        const data = await res.json();

        if (!data.success) {
            return alert(data.message || "L·ªói kh√¥ng x√°c ƒë·ªãnh!");
        }

        alert("ƒê√£ th√™m m·ªëc th√†nh c√¥ng!");
        closeMilestoneModal();
        location.reload();
    }

    // ==================== STREAK ====================
    document.addEventListener('DOMContentLoaded', function() {
        updateStreakDisplay();
    });

    function updateStreakDisplay() {
        const currentStreak = <%- JSON.stringify(coupleInfo.current_streak)%>;
        const bestStreak = <%- JSON.stringify(coupleInfo.max_streak)%>;
        const progressPercent = (currentStreak / bestStreak) * 100;
        const progressBar = document.querySelector('.progress-bar');
        if (progressBar) {
            progressBar.style.setProperty('--progress', progressPercent);
        }
    }
</script>